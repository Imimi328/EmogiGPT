<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emogi Chatbot</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'></circle><line x1='15' y1='9' x2='9' y2='15'></line><line x1='9' y1='9' x2='15' y2='15'></line></svg>">

  <!-- Marked UMD + marked-highlight UMD -->
  <script src="https://cdn.jsdelivr.net/npm/marked@14.1.2/lib/marked.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked-highlight@2.0.2/lib/index.umd.js"></script>

  <!-- highlight.js + style -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github-dark.min.css" />

  <!-- DOMPurify -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.7/purify.min.js"></script>

  <style>
    /* Minimal CSS for functionality (expand as needed) */
    :root { --bg: #fff; --text: #333; --muted: #666; }
    [data-theme="dark"] { --bg: #1a1a1a; --text: #eee; --muted: #aaa; }
    body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; }
    aside { width: 260px; background: var(--bg); border-right: 1px solid #ddd; overflow-y: auto; }
    main { flex: 1; display: flex; flex-direction: column; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #ddd; background: var(--bg); }
    .btn { background: none; border: 1px solid var(--muted); border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 14px; }
    .btn.ok.green { background: #4caf50 !important; color: white; border-color: #4caf50; }
    .btn.red { background: #f44336 !important; color: white; border-color: #f44336; }
    #banner { padding: 8px 16px; background: #fff3cd; color: #856404; border-bottom: 1px solid #ffeaa7; display: none; text-align: center; }
    #banner.ok { background: #d4edda; color: #155724; border-color: #c3e6cb; }
    #chat-container { flex: 1; overflow-y: auto; padding: 16px; }
    .message { margin-bottom: 16px; }
    .message.user { text-align: right; }
    .content { max-width: 80%; margin: 0 auto; padding: 12px; border-radius: 18px; background: #e3f2fd; }
    .message.bot .content { background: #f5f5f5; }
    #empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
    form { display: flex; padding: 16px; border-top: 1px solid #ddd; background: var(--bg); }
    input { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 12px 16px; outline: none; }
    button { margin-left: 8px; border-radius: 20px; padding: 12px 16px; background: #007bff; color: white; border: none; cursor: pointer; }
    .waiting-card { opacity: 0.8; }
    .suggestion-chip { background: #e9ecef; border: 1px solid #dee2e6; padding: 8px 12px; border-radius: 20px; margin: 4px; cursor: pointer; }
    .chat-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px; }
    .chat-item.active { background: #f0f0f0; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #007bff; }
  </style>
</head>
<body data-theme="light">
  <aside>
    <div class="sidebar-header" style="padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd;">
      <button id="new-chat" class="btn">+ New</button>
      <span class="brand" style="font-weight: bold; color: var(--text);">Emogi</span>
      <button id="delete-chat" class="btn">ðŸ—‘</button>
    </div>
    <div id="chat-list" class="chat-list" style="padding: 8px;"></div>
    <div class="sidebar-footer" style="padding: 16px; text-align: center; color: var(--muted); border-top: 1px solid #ddd;">Emogi Chatbot</div>
  </aside>

  <main>
    <header>
      <div class="header-actions" style="display: flex; gap: 8px;">
        <button id="theme-toggle" class="btn">ðŸŒ“</button>
      </div>
      <div id="chat-title" class="header-title" style="flex: 1; text-align: center; font-weight: bold;">New Chat</div>
      <div class="header-actions" style="display: flex; gap: 8px; align-items: center;">
        <div class="lang-selects" style="display: flex; gap: 4px; align-items: center; font-size: 0.85em;">
          <label style="color: var(--muted);">Input</label>
          <select id="src-lang" class="btn" style="padding: 4px 8px; min-width: 80px;"></select>
          <label style="color: var(--muted);">Reply</label>
          <select id="tgt-lang" class="btn" style="padding: 4px 8px; min-width: 80px;"></select>
        </div>
        <span id="latency-chip" class="btn" style="opacity: 0.6;">â€“ ms</span>
      </div>
    </header>

    <div id="banner" role="status" aria-live="polite"></div>

    <div id="chat-container"></div>

    <section id="empty-state" class="empty-state">
      <div class="empty-title" style="font-size: 1.5em; margin-bottom: 8px;">Start a conversation</div>
      <div class="empty-sub" style="margin-bottom: 24px; color: var(--muted);">Ask for code help, translations, summaries, or ideas.</div>
      <div class="empty-chips" id="empty-chips" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;"></div>
    </section>

    <form id="input-form">
      <input type="text" id="input" placeholder="Type a message..." autocomplete="off" required />
      <button type="submit" id="send">Send</button>
      <button type="button" id="stop" style="display: none;">Stop</button>
    </form>
  </main>

  <script>
    // ========= Config =========
    const DEBUG_MODE = false; // Set true for payload logs
    const apiUrl = 'https://api.emogi.space/v1/chat/completions'; // Your remote API
    const modelName = 'openai/gpt-oss-20b.ggufs'; // Your GGUF model
    const apiKey = ''; // If needed for auth
    const TRANS_BASE = 'https://transapi.emogi.space'; // Your translator
    const USE_TRANS = true;
    const USE_STREAM = false;
    const TRANS_TIMEOUT_MS = 10000;
    const TIMEOUT_MS = 180000;
    const MAX_RETRIES = 3;
    const BACKOFF_BASE_MS = 600;
    const BACKOFF_CAP_MS = 8000;

    const systemPrompt = 'You are a helpful AI model developed by Ritesh Verma, the CEO of Team Emogi. Your primary role is to assist with programming, video editing, AI, game development, and creative tasks. You represent Team Emogi, a multi-level organization working in AR/VR, AI, animation, space, and game development. Be formal and informative in your tone.';

    const STORAGE_KEY = 'emogiConversationsV7';
    const SETTINGS_KEY = 'emogiSettingsV1';

    if (location.protocol === 'file:') {
      console.warn('file://: Will cause CORS blocks.');
      bannerEl.textContent = 'Serve via HTTP (python -m http.server 8000) to fix CORS.';
      bannerEl.style.display = 'block';
    }

    // ========= DOM =========
    const chatListEl = document.getElementById('chat-list');
    const newChatBtn = document.getElementById('new-chat');
    const delChatBtn = document.getElementById('delete-chat');
    const chatTitleEl = document.getElementById('chat-title');
    const bannerEl = document.getElementById('banner');
    const chatContainer = document.getElementById('chat-container');
    const emptyState = document.getElementById('empty-state');
    const emptyChips = document.getElementById('empty-chips');
    const inputForm = document.getElementById('input-form');
    const inputField = document.getElementById('input');
    const sendButton = document.getElementById('send');
    const stopButton = document.getElementById('stop');
    const themeToggle = document.getElementById('theme-toggle');
    const latencyChip = document.getElementById('latency-chip');
    const srcLangSel = document.getElementById('src-lang');
    const tgtLangSel = document.getElementById('tgt-lang');

    // ========= Language Codes =========
    const FLORES = {
      "Assamese": "asm_Beng", "Bengali": "ben_Beng", "Bodo": "brx_Deva", "Dogri": "doi_Deva", "English": "eng_Latn",
      "Gujarati": "guj_Gujr", "Hindi": "hin_Deva", "Kannada": "kan_Knda", "Kashmiri (Arabic)": "kas_Arab", "Kashmiri (Devanagari)": "kas_Deva",
      "Konkani": "gom_Deva", "Maithili": "mai_Deva", "Malayalam": "mal_Mlym", "Marathi": "mar_Deva", "Manipuri (Bengali)": "mni_Beng",
      "Manipuri (Meitei)": "mni_Mtei", "Nepali": "npi_Deva", "Odia": "ory_Orya", "Punjabi": "pan_Guru", "Sanskrit": "san_Deva",
      "Santali (Ol Chiki)": "sat_Olck", "Sindhi (Arabic)": "snd_Arab", "Sindhi (Devanagari)": "snd_Deva", "Tamil": "tam_Taml", "Telugu": "tel_Telu", "Urdu": "urd_Arab"
    };
    const HUMAN_BY_CODE = Object.fromEntries(Object.entries(FLORES).map(([k,v]) => [v,k]));

    function populateLanguageSelects() {
      srcLangSel.innerHTML = '<option value="auto">Auto</option><option value="eng_Latn">English</option>' + 
        Object.entries(FLORES).filter(([name]) => name !== 'English').map(([name, code]) => `<option value="${code}">${name}</option>`).join('');
      tgtLangSel.innerHTML = '<option value="same">Same</option><option value="eng_Latn">English</option>' + 
        Object.entries(FLORES).filter(([name]) => name !== 'English').map(([name, code]) => `<option value="${code}">${name}</option>`).join('');
    }

    // ========= Theme =========
    function loadSettings() { try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'); } catch { return {}; } }
    function saveSettings(settings) { try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); } catch {} }
    const settings = loadSettings();
    const isDark = settings.theme === 'dark' || (!settings.theme && window.matchMedia('(prefers-color-scheme: dark)').matches);
    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    themeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
    themeToggle.addEventListener('click', () => {
      const nextTheme = isDark ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', nextTheme);
      themeToggle.setAttribute('aria-pressed', nextTheme === 'dark');
      settings.theme = nextTheme; saveSettings(settings);
    });

    // ========= Banners =========
    function showBanner(msg, ok = false) { 
      bannerEl.textContent = msg; 
      bannerEl.className = ok ? 'ok' : ''; 
      bannerEl.style.display = 'block'; 
    }
    function hideBanner() { bannerEl.style.display = 'none'; }

    // ========= Storage =========
    function safeGetItem(key) { try { return localStorage.getItem(key); } catch { return null; } }
    function safeSetItem(key, value) { try { localStorage.setItem(key, value); return true; } catch { return false; } }

    // ========= Data Model =========
    function uid() { return 'c' + Math.random().toString(36).slice(2, 10); }
    function loadConversations() {
      const raw = safeGetItem(STORAGE_KEY);
      try { const parsed = raw ? JSON.parse(raw) : []; return Array.isArray(parsed) ? parsed : []; } catch { return []; }
    }
    let conversations = loadConversations();
    let activeId = conversations.length ? conversations[0].id : null;

    function saveConversations() { safeSetItem(STORAGE_KEY, JSON.stringify(conversations)); }

    function createConversation() {
      const conv = { id: uid(), title: 'New Chat', messages: [] };
      conversations.unshift(conv);
      saveConversations();
      return conv;
    }
    function getActiveConversation() { return conversations.find(c => c.id === activeId) || null; }
    function ensureActiveConversation() {
      let conv = getActiveConversation();
      if (!conv) {
        conv = conversations.length ? conversations[0] : createConversation();
        activeId = conv.id; saveConversations();
      }
      return conv;
    }
    function deleteConversation(id) {
      const idx = conversations.findIndex(c => c.id === id);
      if (idx >= 0) conversations.splice(idx, 1);
      if (!conversations.length) { const conv = createConversation(); activeId = conv.id; }
      else activeId = conversations[0].id;
      saveConversations();
    }
    function updateTitleFromFirstUser(conv) {
      const first = conv.messages.find(m => m.sender === 'user');
      if (first) conv.title = (first.text || '').slice(0, 40) + ((first.text || '').length > 40 ? 'â€¦' : '');
    }

    // ========= Payload Builder =========
    function buildMessagesPayload(conv) {
      const last = (conv.messages || []).slice(-12).map(m => ({
        role: m.sender === 'user' ? 'user' : 'assistant',
        content: String(m.text || '')
      }));
      return [{ role: 'system', content: systemPrompt }, ...last];
    }

    // ========= Markdown =========
    let md = null;
    function initMarked() {
      try {
        if (window.marked && window.markedHighlight) {
          const Marked = window.marked.Marked;
          md = new Marked(window.markedHighlight({
            langPrefix: 'hljs language-',
            highlight(code, lang) {
              const language = window.hljs?.getLanguage(lang) ? lang : 'plaintext';
              return window.hljs.highlight(code, { language }).value;
            }
          }));
          md.setOptions({ gfm: true, breaks: true });
        } else if (window.marked?.parse) {
          md = window.marked;
          md.setOptions({ gfm: true, breaks: true });
        }
      } catch (e) { console.warn('Marked failed', e); md = null; }
    }

    function sanitizeHTML(html) {
      try { return window.DOMPurify ? window.DOMPurify.sanitize(html) : html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, ''); } catch { return html; }
    }

    function renderMarkdownToHTML(markdown) {
      if (!md) {
        const div = document.createElement('div');
        div.textContent = markdown || '';
        return div.innerHTML;
      }
      try { return sanitizeHTML(md.parse(markdown || '')); } catch { return (markdown || '').replace(/\n/g, '<br>'); }
    }

    function openLinksSafely(container) {
      container.querySelectorAll('a[href]').forEach(a => { a.target = '_blank'; a.rel = 'noopener noreferrer'; });
    }

    function enhanceCodeBlocks(root) {
      root.querySelectorAll('pre > code').forEach(code => {
        const pre = code.parentElement;
        const lang = code.className.replace('language-', '') || 'text';
        const wrap = document.createElement('div'); wrap.className = 'code-wrap';
        const header = document.createElement('div'); header.className = 'code-header';
        header.innerHTML = `<span class="lang">${lang.toUpperCase()}</span><button class="copy-btn" type="button">Copy</button>`;
        header.querySelector('.copy-btn').addEventListener('click', () => navigator.clipboard.writeText(code.textContent));
        wrap.appendChild(header);
        wrap.appendChild(pre);
        pre.replaceWith(wrap);
        if (window.hljs) window.hljs.highlightElement(code);
      });
    }

    function scrollBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

    // ========= Utilities =========
    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ========= Starters =========
    const START_CATEGORIES = {
      'Unity & Games': ['Write a Unity door script.', 'Fix collider overlap.'],
      'Web & JS': ['Build theme toggle.', 'Optimize parallax scroll.'],
      'Python & Streaming': ['Optimize socket streaming.', 'Reduce latency chunking.'],
      'AI & LLM': ['Draft coding prompt guide.', 'Explain GGUF quantization.'],
      'YouTube & Content': ['Outline tutorial script.', 'Write thumbnail copy.'],
      'Translations (Indic)': ['Translate Hindi to English.', 'Localize UI to Marathi.']
    };
    function generateStartersPool() {
      let pool = [];
      Object.values(START_CATEGORIES).forEach(arr => pool.push(...arr));
      const actions = ['Explain', 'Refactor', 'Summarize'];
      const subjects = ['this code', 'this error', 'this idea'];
      actions.forEach(a => subjects.forEach(su => pool.push(`${a} ${su}.`)));
      return shuffleInPlace(pool);
    }
    let STARTERS_POOL = generateStartersPool();

    // ========= Waiting =========
    let waitingNode = null;
    function showWaitingWidget() {
      hideWaitingWidget();
      const wrapper = document.createElement('div');
      wrapper.className = 'message bot waiting-card';
      wrapper.innerHTML = '<div class="content"><div>Thinking...</div></div>';
      chatContainer.appendChild(wrapper);
      scrollBottom();
      waitingNode = wrapper;
    }
    function hideWaitingWidget() { if (waitingNode) waitingNode.remove(); waitingNode = null; }

    // ========= Rendering =========
    function renderChatList() {
      chatListEl.innerHTML = '';
      conversations.forEach(c => {
        const item = document.createElement('div');
        item.className = `chat-item ${c.id === activeId ? 'active' : ''}`;
        item.innerHTML = `<div class="dot"></div><div class="title">${c.title || 'New Chat'}</div>`;
        item.addEventListener('click', () => { activeId = c.id; renderChatList(); renderActiveConversation(); });
        chatListEl.appendChild(item);
      });
    }

    function addMessageToDOM(message) {
      const wrapper = document.createElement('div');
      wrapper.className = `message ${message.sender}`;
      const content = document.createElement('div');
      content.className = 'content';
      if (message.sender === 'bot' && message.text) {
        const html = renderMarkdownToHTML(message.text);
        const temp = document.createElement('div');
        temp.innerHTML = html;
        openLinksSafely(temp);
        enhanceCodeBlocks(temp);
        content.append(...temp.childNodes);
      } else {
        content.textContent = message.text || '';
      }
      wrapper.appendChild(content);
      wrapper.innerHTML += `<div class="msg-meta">${message.meta || ''}</div>`;
      chatContainer.appendChild(wrapper);
    }

    function renderEmptyState() {
      emptyChips.innerHTML = '';
      emptyState.hidden = false;
      shuffleInPlace([...STARTERS_POOL]).slice(0, 3).forEach(txt => {
        const btn = document.createElement('button');
        btn.className = 'suggestion-chip';
        btn.textContent = txt;
        btn.addEventListener('click', () => { inputField.value = txt; inputField.focus(); });
        emptyChips.appendChild(btn);
      });
    }

    function renderActiveConversation() {
      hideBanner();
      const conv = ensureActiveConversation();
      chatTitleEl.textContent = conv.title || 'New Chat';
      chatContainer.innerHTML = '';
      emptyState.hidden = conv.messages?.length > 0;
      if (emptyState.hidden) {
        conv.messages.forEach(addMessageToDOM);
      } else {
        renderEmptyState();
      }
      scrollBottom();
    }

    // Initial UI
    ensureActiveConversation();
    populateLanguageSelects();
    renderChatList();
    renderActiveConversation();
    newChatBtn.addEventListener('click', () => {
      const conv = createConversation();
      activeId = conv.id;
      renderChatList();
      renderActiveConversation();
      inputField.focus();
    });
    delChatBtn.addEventListener('click', () => {
      if (activeId && confirm('Delete chat?')) {
        deleteConversation(activeId);
        renderChatList();
        renderActiveConversation();
      }
    });
    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        inputForm.submit();
      }
    });

    // ========= Networking =========
    let inFlightController = null;
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    function backoffDelay(attempt) { return Math.min(BACKOFF_BASE_MS * Math.pow(2, attempt), BACKOFF_CAP_MS); }

    stopButton.addEventListener('click', () => { 
      if (inFlightController) inFlightController.abort(); 
      showBanner('Stopped.', true); 
      hideWaitingWidget(); 
    });

    async function chatRequest(payload) {
      if (!payload.messages?.length) throw new Error('Missing messages');
      if (DEBUG_MODE) console.log('Sending payload:', JSON.stringify(payload, null, 2));

      let attempt = 0;
      const t0 = performance.now();
      while (attempt <= MAX_RETRIES) {
        const controller = new AbortController();
        inFlightController = controller;
        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
        try {
          const headers = { 
            'Content-Type': 'application/json',
            ...(apiKey && { 'Authorization': `Bearer ${apiKey}` })
          };
          const res = await fetch(apiUrl, { 
            method: 'POST', 
            headers, 
            body: JSON.stringify(payload), 
            signal: controller.signal 
          });
          clearTimeout(timeoutId);
          if (!res.ok) {
            const errText = await res.text();
            console.error('Server response:', errText);
            const data = JSON.parse(errText || '{}');
            const errMsg = data.error?.message || `HTTP ${res.status}`;
            if (res.status === 429 || res.status >= 500) throw new Error(errMsg); // Retryable
            throw new Error(errMsg);
          }
          const text = await res.text();
          let data; try { data = JSON.parse(text); } catch { throw new Error('Invalid JSON'); }
          latencyChip.textContent = `${Math.round(performance.now() - t0)} ms`;
          return data;
        } catch (err) {
          clearTimeout(timeoutId);
          if (err.name === 'AbortError') throw new Error('Timeout/Canceled');
          const isCORS = err.message.includes('CORS') || err.name === 'TypeError';
          if (isCORS) {
            showBanner('CORS error: Add middleware to backend (allow * origins/methods).', false);
            throw new Error('CORS blocked: Fix server headers for preflights.');
          }
          if (attempt < MAX_RETRIES) {
            const wait = backoffDelay(attempt);
            showBanner(`Retry ${attempt + 1}/${MAX_RETRIES + 1} in ${wait}ms...`);
            await sleep(wait);
            attempt++;
            continue;
          }
          throw err;
        } finally {
          inFlightController = null;
        }
      }
    }

    // ========= Translator =========
    async function translateLocal(text, src, tgt) {
      if (!USE_TRANS || src === tgt || !text) return text;
      try {
        const res = await fetch(`${TRANS_BASE}/translate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, src_lang: src, tgt_lang: tgt, num_beams: 3, max_length: 256 }),
          signal: AbortSignal.timeout(TRANS_TIMEOUT_MS)
        });
        if (!res.ok) throw new Error('Translator failed');
        const data = await res.json();
        return data.translations?.[0] || text;
      } catch (err) {
        console.warn('Translation fallback to raw:', err);
        showBanner('Translator unavailable; using original text.', false); setTimeout(hideBanner, 2000);
        return text;
      }
    }

    function toText(v) { return String(v || ''); }
    function guessFloresByScript(text) {
      if (/[\u0900-\u097F]/.test(text)) return 'hin_Deva';
      if (/[\u0980-\u09FF]/.test(text)) return 'ben_Beng';
      if (/[\u0A80-\u0AFF]/.test(text)) return 'guj_Gujr';
      if (/[\u0B00-\u0B7F]/.test(text)) return 'ory_Orya';
      if (/[\u0B80-\u0BFF]/.test(text)) return 'tam_Taml';
      if (/[\u0C00-\u0C7F]/.test(text)) return 'tel_Telu';
      if (/[\u0C80-\u0CFF]/.test(text)) return 'kan_Knda';
      if (/[\u0D00-\u0D7F]/.test(text)) return 'mal_Mlym';
      if (/[\u0600-\u06FF]/.test(text)) return 'urd_Arab';
      return 'eng_Latn';
    }

    // ========= Submit =========
    inputForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userMessage = inputField.value.trim();
      if (!userMessage) return;
      let conv = ensureActiveConversation();
      emptyState.hidden = true;

      const userChat = { sender: 'user', text: userMessage, meta: new Date().toLocaleTimeString() };
      conv.messages.push(userChat);
      updateTitleFromFirstUser(conv);
      saveConversations();
      renderChatList();
      addMessageToDOM(userChat);

      inputField.value = '';
      inputField.focus();
      sendButton.disabled = true;
      stopButton.style.display = 'inline-block';
      showWaitingWidget();

      try {
        let srcFlores = srcLangSel.value === 'auto' ? guessFloresByScript(userMessage) : srcLangSel.value;
        let outFlores = tgtLangSel.value === 'same' ? srcFlores : tgtLangSel.value;

        let userInEnglish = srcFlores === 'eng_Latn' ? userMessage : await translateLocal(userMessage, srcFlores, 'eng_Latn');

        let payload = { model: modelName, stream: USE_STREAM, messages: buildMessagesPayload(conv) };
        for (let i = payload.messages.length - 1; i >= 0; i--) {
          if (payload.messages[i].role === 'user') {
            payload.messages[i].content = userInEnglish;
            break;
          }
        }

        const data = await chatRequest(payload);
        let replyEn = toText(data.choices?.[0]?.message?.content || 'No response');

        let replyOut = outFlores === 'eng_Latn' ? replyEn : await translateLocal(replyEn, 'eng_Latn', outFlores);

        const botMessage = { sender: 'bot', text: replyOut, meta: new Date().toLocaleTimeString() };
        addMessageToDOM(botMessage);
        conv.messages.push(botMessage);
        saveConversations();
        scrollBottom();
        showBanner('Done', true);
      } catch (err) {
        console.error('Error:', err);
        const errMsg = err.message.includes('CORS') ? 'CORS: Update backend middleware for OPTIONS requests.' : err.message;
        const errorMessage = { sender: 'bot', text: `Error: ${errMsg}`, meta: new Date().toLocaleTimeString() };
        conv.messages.push(errorMessage);
        addMessageToDOM(errorMessage);
        saveConversations();
        showBanner(errMsg, false);
      } finally {
        hideWaitingWidget();
        sendButton.disabled = false;
        stopButton.style.display = 'none';
        inputField.focus();
      }
    });

    // Load init
    window.addEventListener('load', () => {
      initMarked();
      inputField.focus();
    });
  </script>
</body>
</html>

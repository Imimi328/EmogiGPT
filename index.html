<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emogi Chatbot</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">

  <!-- Marked UMD + marked-highlight UMD -->
  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked-highlight/lib/index.umd.js"></script>

  <!-- highlight.js + style -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css" />

  <!-- DOMPurify (sanitize rendered HTML) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

</head>
<body>
  <aside>
    <div class="sidebar-header">
      <button id="new-chat" class="btn" title="Start new chat">+ New</button>
      <button id="delete-chat" class="btn" title="Delete current chat">ðŸ—‘</button>
      <span class="brand">Emogi</span>
    </div>
    <div id="chat-list" class="chat-list"></div>
    <div class="sidebar-footer">Emogi Chatbot</div>
  </aside>

  <main>
    <header>
      <div class="header-actions">
        <button id="theme-toggle" class="btn" title="Toggle theme" aria-pressed="false">ðŸŒ“</button>
      </div>
      <div id="chat-title" class="header-title">New Chat</div>
      <div class="header-actions">
        <div class="lang-selects" style="display:flex; gap:6px; align-items:center;">
          <label for="src-lang" style="font-size:.85em; color:var(--muted);">Input</label>
          <select id="src-lang" class="btn" style="padding:8px;">
            <option value="auto">Auto</option>
          </select>
          <label for="tgt-lang" style="font-size:.85em; color:var(--muted);">Reply</label>
          <select id="tgt-lang" class="btn" style="padding:8px;">
            <option value="same">Same</option>
          </select>
        </div>
        <span id="latency-chip" class="btn" title="Last response time" style="opacity:.8; cursor:default;">â€“ ms</span>
        <span id="status-chip" class="btn" title="API Status" style="opacity:.6; cursor:default;">Checking...</span>
      </div>
    </header>

    <div id="banner" role="status" aria-live="polite" aria-atomic="true"></div>

    <div id="chat-container"></div>

    <section id="empty-state" class="empty-state" hidden>
      <div class="empty-title">Start a conversation</div>
      <div class="empty-sub">Ask for code help, translations, summaries, or ideas.</div>
      <div class="empty-chips" id="empty-chips"></div>
    </section>

    <form id="input-form" novalidate>
      <input type="text" id="input" placeholder="Type a message..." autocomplete="off" required enterkeyhint="send" />
      <button type="button" id="stop" title="Cancel inâ€‘flight request">Stop</button>
      <button type="submit" id="send">Send</button>
    </form>
  </main>

  <script>
    // ========= Config =========
    const DEBUG_MODE = true; // Enable for full logs
    let currentModel = 'local-model'; // Dynamic from health check
    const apiUrl = 'http://localhost:1234/v1/chat/completions';
    const apiKey = '';

    const TRANS_BASE = 'http://localhost:5000'; // Local translator
    const USE_TRANS = true;
    const USE_STREAM = false;
    const TRANS_TIMEOUT_MS = 10000;
    const TIMEOUT_MS = 300000; // 5min
    const MAX_RETRIES = 0; // No retries for local

    const systemPrompt = 'You are a helpful AI model developed by Ritesh Verma, the CEO of Team Emogi. Your primary role is to assist with programming, video editing, AI, game development, and creative tasks. You represent Team Emogi, a multi-level organization working in AR/VR, AI, animation, space, and game development. Be formal and informative in your tone.';

    const STORAGE_KEY = 'emogiConversationsV7';
    const SETTINGS_KEY = 'emogiSettingsV1';

    if (location.protocol === 'file:') {
      console.warn('file:// detected: Serve via HTTP server.');
      document.getElementById('banner').textContent = 'Use python -m http.server 8000 for proper origin.';
      document.getElementById('banner').style.display = 'block';
    }

    // ========= DOM Elements =========
    const chatListEl = document.getElementById('chat-list');
    const newChatBtn = document.getElementById('new-chat');
    const delChatBtn = document.getElementById('delete-chat');
    const chatTitleEl = document.getElementById('chat-title');
    const bannerEl = document.getElementById('banner');
    const chatContainer = document.getElementById('chat-container');
    const emptyState = document.getElementById('empty-state');
    const emptyChips = document.getElementById('empty-chips');
    const inputForm = document.getElementById('input-form');
    const inputField = document.getElementById('input');
    const sendButton = document.getElementById('send');
    const stopButton = document.getElementById('stop');
    const themeToggle = document.getElementById('theme-toggle');
    const latencyChip = document.getElementById('latency-chip');
    const statusChip = document.getElementById('status-chip');
    const srcLangSel = document.getElementById('src-lang');
    const tgtLangSel = document.getElementById('tgt-lang');

    // ========= Language Selects, Theme, Banners, Storage, Data Model, Markdown, Utilities, Starters, Waiting, Rendering =========
    // (Omitted for brevity; copy full from previous response: populateLanguageSelects, loadSettings/saveSettings, showBanner/hideBanner, storage helpers, uid/loadConversations/createConversation/etc., initMarked/renderMarkdownToHTML/enhanceCodeBlocks, shuffleInPlace, START_CATEGORIES/generateStartersPool, showWaitingWidget/hideWaitingWidget, renderChatList/addMessageToDOM/renderEmptyState/renderActiveConversation)

    // Example placeholders (ensure full implementation):
    function populateLanguageSelects() { /* full code from prev */ }
    function showBanner(msg, ok=false) { /* full */ }
    function buildMessagesPayload(conv) { /* full */ }
    function ensureActiveConversation() { /* full */ }
    // ... (all prior functions)

    // ========= API Health Check with Dynamic Model =========
    async function checkApiHealth() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const res = await fetch('http://localhost:1234/v1/models', { 
          method: 'GET', 
          signal: controller.signal 
        });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data.data && data.data.length > 0) {
          currentModel = data.data[0].id; // Use first loaded model [web:16]
          statusChip.textContent = `Ready (${currentModel})`; 
          statusChip.classList.add('ok', 'green'); // Assume CSS for .green
          if (DEBUG_MODE) console.log('Models loaded:', data.data.map(m => m.id));
          return true;
        }
        throw new Error('No models loaded');
      } catch (err) {
        if (DEBUG_MODE) console.error('Health check error:', err);
        const errMsg = err.name === 'AbortError' ? 'Timeout' : err.message.includes('BLOCKED_BY_CLIENT') ? 'Blocked by browser' : err.message;
        statusChip.textContent = `Error: ${errMsg}`; 
        statusChip.classList.remove('ok'); 
        statusChip.classList.add('red');
        showBanner(`LM Studio: ${errMsg}. Start server, load model (e.g., gpt-oss-20b.ggufs). Test: curl http://localhost:1234/v1/models`, false);
        return false;
      }
    }

    // ========= Networking =========
    let inFlightController = null;
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    stopButton.addEventListener('click', () => {
      if (inFlightController) inFlightController.abort();
      showBanner('Canceled.', true); hideWaitingWidget();
    });

    async function chatRequest(payload) {
      if (!payload.messages?.length) throw new Error('Missing messages');
      payload.model = currentModel; // Dynamic model
      if (DEBUG_MODE) console.log('Sending to LM Studio:', JSON.stringify(payload, null, 2));

      const healthOk = await checkApiHealth();
      if (!healthOk) throw new Error('LM Studio not ready - check banner.');

      const controller = new AbortController();
      inFlightController = controller;
      const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
      const t0 = performance.now();
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;
        const res = await fetch(apiUrl, { 
          method: 'POST', 
          headers, 
          body: JSON.stringify(payload), 
          signal: controller.signal 
        });
        clearTimeout(timeoutId);
        if (!res.ok) {
          const errText = await res.text();
          if (DEBUG_MODE) console.error('LM Studio error:', errText);
          throw new Error(`LM Studio: ${res.status} - ${errText}`);
        }
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { throw new Error('Invalid JSON response'); }
        const t1 = performance.now();
        latencyChip.textContent = `${Math.round(t1 - t0)} ms`;
        return data;
      } catch (err) {
        clearTimeout(timeoutId);
        if (DEBUG_MODE) console.error('Fetch error details:', err);
        const isAbort = err.name === 'AbortError';
        if (isAbort) throw new Error('Request timed out or canceled');
        
        const isBlocked = err.message.includes('BLOCKED_BY_CLIENT') || err.name === 'TypeError' && err.message.includes('fetch');
        if (isBlocked) {
          showBanner('Request blocked by browser (adblocker/VPN?). Whitelist localhost:1234 or test in Incognito.', false);
          throw new Error('Blocked by client: Disable adblocker for localhost, restart browser.');
        }
        
        const isCORS = err.message.includes('CORS') && location.protocol !== 'file:';
        if (isCORS) {
          showBanner('CORS error: Enable CORS in LM Studio settings.', false);
          throw new Error('CORS blocked: Enable in LM Studio > Local Server.');
        }
        
        // Generic network error
        showBanner('Network error: Verify LM Studio on port 1234 (curl test).', false);
        throw new Error(`Connection failed: ${err.message}. Run curl POST to /chat/completions.`);
      } finally {
        inFlightController = null;
      }
    }

    // ========= Translator ========= (unchanged, fallback on error)
    async function translateLocal(text, srcFlores, tgtFlores) {
      if (!USE_TRANS || !text || srcFlores === tgtFlores) return text;
      // Full code from prev: fetch to TRANS_BASE, fallback to text on error
      // ...
      return text; // Simplified placeholder
    }

    function toText(v) { return String(v ?? ''); }
    function guessFloresByScript(text) { /* full from prev */ return 'eng_Latn'; }

    // ========= Submit Handler =========
    inputForm.addEventListener('submit', async (e) => {
      e.preventDefault(); hideBanner();

      const userMessage = inputField.value.trim(); if (!userMessage) return;
      let conv = ensureActiveConversation(); emptyState.hidden = true;

      const userChat = { sender: 'user', text: userMessage, meta: new Date().toLocaleTimeString() };
      conv.messages.push(userChat);
      if (conv.title === 'New Chat') updateTitleFromFirstUser(conv); // Assume function exists
      saveConversations(); renderChatList(); addMessageToDOM(userChat);

      inputField.value = ''; inputField.focus();
      sendButton.disabled = true; stopButton.style.display = 'inline-block';
      showWaitingWidget();

      try {
        let srcFlores = srcLangSel.value === 'auto' ? guessFloresByScript(userMessage) : srcLangSel.value;
        let outFlores = tgtLangSel.value === 'same' ? srcFlores : tgtLangSel.value;

        let userInEnglish = userMessage;
        if (srcFlores !== 'eng_Latn') userInEnglish = await translateLocal(userMessage, srcFlores, 'eng_Latn');

        let payload = { stream: USE_STREAM, messages: buildMessagesPayload(conv) };
        // Override last user
        for (let i = payload.messages.length - 1; i >= 0; i--) {
          if (payload.messages[i].role === 'user') { payload.messages[i].content = userInEnglish; break; }
        }

        const data = await chatRequest(payload);
        let replyEn = toText(data?.choices?.[0]?.message?.content ?? 'No response');

        let replyOut = replyEn;
        if (outFlores !== 'eng_Latn') replyOut = await translateLocal(replyEn, 'eng_Latn', outFlores);

        const botMessage = { sender: 'bot', text: replyOut, meta: new Date().toLocaleTimeString() };
        addMessageToDOM(botMessage); conv.messages.push(botMessage); saveConversations(); scrollBottom();
        showBanner('Done.', true); setTimeout(hideBanner, 700);
      } catch (err) {
        console.error('Chat error:', err);
        const errMsg = err.message; // Use full for user
        const errorMessage = { sender: 'bot', text: `Error: ${errMsg}`, meta: new Date().toLocaleTimeString() };
        conv.messages.push(errorMessage); addMessageToDOM(errorMessage); saveConversations();
        showBanner(errMsg, false);
      } finally {
        hideWaitingWidget(); sendButton.disabled = false; stopButton.style.display = 'none'; inputField.focus();
        checkApiHealth(); // Refresh
      }
    });

    // Initial load
    window.addEventListener('load', async () => {
      populateLanguageSelects(); // And other inits
      inputField.focus();
      await checkApiHealth();
    });

    // Other event listeners (keydown, newChatBtn, delChatBtn) from prev
    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); inputForm.submit(); }
    });
    ensureActiveConversation(); renderChatList(); renderActiveConversation();
    // newChatBtn/delChatBtn listeners...
  </script>
  <style>
    /* Basic for status */
    .btn.ok.green { background: #4caf50; color: white; }
    .btn.red { background: #f44336; color: white; }
  </style>
</body>
</html>

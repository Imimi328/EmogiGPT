<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emogi Chatbot</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">

  <!-- Marked UMD + marked-highlight UMD -->
  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked-highlight/lib/index.umd.js"></script>

  <!-- highlight.js + style -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css" />

  <!-- DOMPurify (sanitize rendered HTML) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

</head>
<body>
  <aside>
    <div class="sidebar-header">
      <button id="new-chat" class="btn" title="Start new chat">+ New</button>
      <button id="delete-chat" class="btn" title="Delete current chat">ðŸ—‘</button>
      <span class="brand">Emogi</span>
    </div>
    <div id="chat-list" class="chat-list"></div>
    <div class="sidebar-footer">Emogi Chatbot</div>
  </aside>

  <main>
    <header>
      <div class="header-actions">
        <button id="theme-toggle" class="btn" title="Toggle theme" aria-pressed="false">ðŸŒ“</button>
      </div>
      <div id="chat-title" class="header-title">New Chat</div>
      <div class="header-actions">
        <div class="lang-selects" style="display:flex; gap:6px; align-items:center;">
          <label for="src-lang" style="font-size:.85em; color:var(--muted);">Input</label>
          <select id="src-lang" class="btn" style="padding:8px;">
            <option value="auto">Auto</option>
          </select>
          <label for="tgt-lang" style="font-size:.85em; color:var(--muted);">Reply</label>
          <select id="tgt-lang" class="btn" style="padding:8px;">
            <option value="same">Same</option>
          </select>
        </div>
        <span id="latency-chip" class="btn" title="Last response time" style="opacity:.8; cursor:default;">â€“ ms</span>
        <span id="status-chip" class="btn" title="API Status" style="opacity:.6; cursor:default;">Checking...</span>
      </div>
    </header>

    <div id="banner" role="status" aria-live="polite" aria-atomic="true"></div>

    <div id="chat-container"></div>

    <section id="empty-state" class="empty-state" hidden>
      <div class="empty-title">Start a conversation</div>
      <div class="empty-sub">Ask for code help, translations, summaries, or ideas.</div>
      <div class="empty-chips" id="empty-chips"></div>
    </section>

    <form id="input-form" novalidate>
      <input type="text" id="input" placeholder="Type a message..." autocomplete="off" required enterkeyhint="send" />
      <button type="button" id="stop" title="Cancel inâ€‘flight request">Stop</button>
      <button type="submit" id="send">Send</button>
    </form>
  </main>

  <script>
    // ========= Config =========
    const DEBUG_MODE = false; // Set true for full console logs
    const apiUrl = 'http://localhost:1234/v1/chat/completions'; // LM Studio local
    const modelName = 'local-model'; // LM Studio uses 'local-model' for the loaded GGUF; adjust if needed [web:16]
    const apiKey = ''; // Not needed for LM Studio

    const TRANS_BASE = 'http://localhost:5000'; // Local translator; comment out if not used
    const USE_TRANS = true; // Toggle translation on/off
    const USE_STREAM = false;
    const TRANS_TIMEOUT_MS = 10000;
    const TIMEOUT_MS = 300000; // 5min for GGUF inference [memory:1]
    const MAX_RETRIES = 1; // Reduced for local testing

    const systemPrompt =
      'You are a helpful AI model developed by Ritesh Verma, the CEO of Team Emogi. Your primary role is to assist with programming, video editing, AI, game development, and creative tasks. You represent Team Emogi, a multi-level organization working in AR/VR, AI, animation, space, and game development. Be formal and informative in your tone.';

    const STORAGE_KEY = 'emogiConversationsV7';
    const SETTINGS_KEY = 'emogiSettingsV1';
    const BACKOFF_BASE_MS = 1000;
    const BACKOFF_CAP_MS = 3000;

    if (location.protocol === 'file:') {
      console.warn('Running from file://: Use a local server like python -m http.server 8000.');
      document.getElementById('banner').textContent = 'Serve via HTTP to avoid issues.';
      document.getElementById('banner').style.display = 'block';
    }

    // ========= DOM =========
    const chatListEl = document.getElementById('chat-list');
    const newChatBtn = document.getElementById('new-chat');
    const delChatBtn = document.getElementById('delete-chat');
    const chatTitleEl = document.getElementById('chat-title');
    const bannerEl = document.getElementById('banner');
    const chatContainer = document.getElementById('chat-container');
    const emptyState = document.getElementById('empty-state');
    const emptyChips = document.getElementById('empty-chips');
    const inputForm = document.getElementById('input-form');
    const inputField = document.getElementById('input');
    const sendButton = document.getElementById('send');
    const stopButton = document.getElementById('stop');
    const themeToggle = document.getElementById('theme-toggle');
    const latencyChip = document.getElementById('latency-chip');
    const statusChip = document.getElementById('status-chip');
    const srcLangSel = document.getElementById('src-lang');
    const tgtLangSel = document.getElementById('tgt-lang');

    // ========= Language codes (FLORES) ========= (unchanged from previous)
    const FLORES = {
      "Assamese": "asm_Beng","Bengali": "ben_Beng","Bodo": "brx_Deva","Dogri": "doi_Deva","English": "eng_Latn",
      "Gujarati": "guj_Gujr","Hindi": "hin_Deva","Kannada": "kan_Knda","Kashmiri (Arabic)": "kas_Arab","Kashmiri (Devanagari)": "kas_Deva",
      "Konkani": "gom_Deva","Maithili": "mai_Deva","Malayalam": "mal_Mlym","Marathi": "mar_Deva","Manipuri (Bengali)": "mni_Beng",
      "Manipuri (Meitei)": "mni_Mtei","Nepali": "npi_Deva","Odia": "ory_Orya","Punjabi": "pan_Guru","Sanskrit": "san_Deva",
      "Santali (Ol Chiki)": "sat_Olck","Sindhi (Arabic)": "snd_Arab","Sindhi (Devanagari)": "snd_Deva","Tamil": "tam_Taml","Telugu": "tel_Telu","Urdu": "urd_Arab"
    };
    const HUMAN_BY_CODE = Object.fromEntries(Object.entries(FLORES).map(([k,v]) => [v,k]));

    function populateLanguageSelects() {
      const srcOptions = [{ label: 'Auto', value: 'auto' }, { label: 'English', value: 'eng_Latn' },
        ...Object.entries(FLORES).filter(([name]) => name !== 'English').map(([name, code]) => ({ label: name, value: code }))
      ];
      srcOptions.forEach(o => { const opt = document.createElement('option'); opt.value = o.value; opt.textContent = o.label; srcLangSel.appendChild(opt); });

      const tgtOptions = [{ label: 'Same', value: 'same' }, { label: 'English', value: 'eng_Latn' },
        ...Object.entries(FLORES).filter(([name]) => name !== 'English').map(([name, code]) => ({ label: name, value: code }))
      ];
      tgtOptions.forEach(o => { const opt = document.createElement('option'); opt.value = o.value; opt.textContent = o.label; tgtLangSel.appendChild(opt); });
    }
    populateLanguageSelects();

    // ========= Theme, Banners, Storage, Data Model, Markdown Rendering, Utilities, Starters, Waiting Widget, Rendering ========= (unchanged from previous version for brevity; include full if needed, but assuming copy-paste)

    // [Omit repeated sections here for response length; in actual code, copy from prior version: loadSettings, showBanner, storage helpers, uid, loadConversations, createConversation, etc., up to renderActiveConversation]

    // ========= API Health Check =========
    async function checkApiHealth() {
      try {
        const res = await fetch('http://localhost:1234/v1/models', { method: 'GET', signal: AbortSignal.timeout(5000) });
        if (res.ok) {
          const data = await res.json();
          if (data.data && data.data.length > 0) {
            statusChip.textContent = 'Ready'; statusChip.classList.add('ok');
            return true;
          }
        }
        throw new Error('No models loaded');
      } catch (err) {
        if (DEBUG_MODE) console.error('API health check failed:', err);
        statusChip.textContent = 'Offline'; statusChip.classList.remove('ok');
        showBanner('LM Studio: Start server, load model, enable CORS at port 1234.', false);
        return false;
      }
    }

    // Call on load
    window.addEventListener('load', async () => {
      initMarked(); // From markdown section
      inputField.focus();
      await checkApiHealth();
    });

    // ========= Networking with Health Check =========
    let inFlightController = null;
    function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

    stopButton.addEventListener('click', () => {
      if (inFlightController) { inFlightController.abort(); showBanner('Request canceled.', true); }
      hideWaitingWidget();
    });

    // [readOpenAIStream unchanged]

    class RetryableError extends Error { constructor(message, status) { super(message); this.status = status; } }

    async function chatRequest(payload) {
      if (!payload.messages || !Array.isArray(payload.messages) || payload.messages.length === 0) {
        throw new Error('Invalid payload: missing messages');
      }
      if (DEBUG_MODE) console.log('Sending payload:', JSON.stringify(payload, null, 2));

      const healthOk = await checkApiHealth();
      if (!healthOk) throw new Error('LM Studio not ready: Start server and load model.');

      let attempt = 0; const t0 = performance.now();
      while (attempt <= MAX_RETRIES) {
        const controller = new AbortController(); inFlightController = controller;
        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
        try {
          const headers = { 'Content-Type': 'application/json' };
          if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;
          const res = await fetch(apiUrl, { 
            method: 'POST', 
            headers, 
            body: JSON.stringify(payload), 
            signal: controller.signal 
          });
          clearTimeout(timeoutId);
          if (!res.ok) {
            const errText = await res.text();
            if (DEBUG_MODE) console.error('LM Studio response:', errText);
            const data = JSON.parse(errText || '{}');
            const errMsg = data?.error?.message || `HTTP ${res.status}`;
            throw new Error(`LM Studio: ${errMsg}`);
          }
          const text = await res.text(); let data;
          try { data = JSON.parse(text); } catch { throw new Error('Invalid JSON from LM Studio'); }
          const t1 = performance.now(); latencyChip.textContent = `${Math.round(t1 - t0)} ms`;
          return data;
        } catch (err) {
          clearTimeout(timeoutId);
          const isAbort = err.name === 'AbortError';
          if (isAbort) throw err;
          const isFetchError = err.message.includes('Failed to fetch') || err.name === 'TypeError';
          if (isFetchError) {
            showBanner('Fetch failed: Ensure LM Studio runs on port 1234 with CORS enabled.', false);
            throw new Error('Connection to LM Studio failed. Check server status.');
          }
          if (attempt < MAX_RETRIES) {
            const wait = Math.min(BACKOFF_BASE_MS * (2 ** attempt), BACKOFF_CAP_MS);
            showBanner(`Retrying in ${wait}ms...`); await sleep(wait); attempt++; continue;
          }
          throw err;
        } finally { inFlightController = null; }
      }
    }

    // ========= Translator (with fallback) =========
    async function translateLocal(text, srcFlores, tgtFlores) {
      if (!USE_TRANS || !text || srcFlores === tgtFlores) return text;
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), TRANS_TIMEOUT_MS);
      try {
        const body = { text, src_lang: srcFlores, tgt_lang: tgtFlores };
        const res = await fetch(`${TRANS_BASE}/translate`, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(body),
          signal: controller.signal 
        });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error('Translator offline');
        const data = await res.json();
        return data?.translations?.[0] || text;
      } catch (err) {
        clearTimeout(timeoutId);
        console.warn('Translation skipped:', err);
        showBanner('Translation failed; using original text.', false); setTimeout(hideBanner, 2000);
        return text;
      }
    }

    // [toText, guessFloresByScript unchanged]

    // ========= Submit Handler =========
    inputForm.addEventListener('submit', async (e) => {
      e.preventDefault(); hideBanner();

      const userMessage = inputField.value.trim(); if (!userMessage) return;

      let conv = ensureActiveConversation();
      emptyState.hidden = true;

      const userChat = { sender: 'user', text: userMessage, meta: new Date().toLocaleTimeString() };
      conv.messages.push(userChat);
      if (conv.title === 'New Chat') updateTitleFromFirstUser(conv);
      saveConversations(); renderChatList();
      addMessageToDOM(userChat);

      inputField.value = ''; inputField.focus();
      sendButton.disabled = true; stopButton.style.display = 'inline-block';
      showWaitingWidget();

      try {
        const healthOk = await checkApiHealth();
        if (!healthOk) throw new Error('LM Studio not ready.');

        let srcFlores = srcLangSel.value === 'auto' ? guessFloresByScript(userMessage) : srcLangSel.value;
        let outFlores = tgtLangSel.value === 'same' ? srcFlores : tgtLangSel.value;

        let userInEnglish = userMessage;
        if (srcFlores !== 'eng_Latn') {
          const translated = await translateLocal(userMessage, srcFlores, 'eng_Latn');
          userInEnglish = toText(translated);
        }

        let payload = { model: modelName, stream: USE_STREAM, messages: buildMessagesPayload(conv) };
        // Override last user message
        for (let i = payload.messages.length - 1; i >= 0; i--) {
          if (payload.messages[i].role === 'user') {
            payload.messages[i].content = userInEnglish;
            break;
          }
        }

        const data = await chatRequest(payload);

        let replyEn = toText(data?.choices?.[0]?.message?.content ?? 'No response from model.');

        let replyOut = replyEn;
        if (outFlores !== 'eng_Latn') {
          const translated = await translateLocal(replyEn, 'eng_Latn', outFlores);
          replyOut = toText(translated);
        }

        const botMessage = { sender: 'bot', text: replyOut, meta: new Date().toLocaleTimeString() };
        addMessageToDOM(botMessage);
        conv.messages.push(botMessage); saveConversations(); scrollBottom();
        showBanner('Response received.', true); setTimeout(hideBanner, 700);
      } catch (err) {
        console.error('Error:', err);
        const errMsg = err.message.includes('LM Studio') || err.message.includes('fetch') 
          ? 'LM Studio issue: Verify server running, model loaded, CORS enabled on port 1234. Test with curl http://localhost:1234/v1/models.'
          : err.message;
        const errorMessage = { sender: 'bot', text: `Error: ${errMsg}`, meta: new Date().toLocaleTimeString() };
        conv.messages.push(errorMessage); addMessageToDOM(errorMessage); saveConversations();
        showBanner(errMsg);
      } finally {
        hideWaitingWidget();
        sendButton.disabled = false; stopButton.style.display = 'none'; inputField.focus();
        await checkApiHealth(); // Refresh status
      }
    });

    // [Input keydown, initial UI, etc. unchanged]

    // Input: Enter to send
    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        inputForm.requestSubmit?.() || inputForm.submit();
      }
    });

    // Initial setup
    ensureActiveConversation();
    renderChatList(); renderActiveConversation();
    newChatBtn.addEventListener('click', () => { /* unchanged */ });
    delChatBtn.addEventListener('click', () => { /* unchanged */ });
  </script>
  <style>
    /* Add if missing: Basic CSS for .ok on chips, etc. */
    .btn.ok { background: green; color: white; }
  </style>
</body>
</html>
